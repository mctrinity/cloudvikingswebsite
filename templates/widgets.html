{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">Info Hub</h2>

    <div class="row">
        <!-- Weather Widget -->
        <div class="col-md-4 custom-card-spacing">
            <div class="card custom-card-shadow">
                <div class="card-body text-center">
                    <h5 class="card-title">Local Weather</h5>
                    <div id="weather-info" class="widget-content">Loading weather data...</div>
                </div>
            </div>
        </div>

        <!-- News Widget -->
        <div class="col-md-4 custom-card-spacing">
            <div class="card custom-card-shadow">
                <div class="card-body text-center">
                    <h5 class="card-title">Latest News</h5>
                    <div id="news-widget" class="widget-content">Loading news...</div>
                </div>
            </div>
        </div>

        <!-- Trending Movies Widget -->
        <div class="col-md-4 custom-card-spacing">
            <div class="card custom-card-shadow">
                <div class="card-body text-center">
                    <h5 class="card-title">Trending Movies</h5>
                    <div id="single-movie" class="widget-content">
                        <!-- The rotating movie will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add custom CSS styling for uniform widget sizing -->
<style>
    /* Base styling for all widgets */
    .widget-content {
        width: 100%;
        max-width: 400px;
        height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 8px;
    }

    /* Weather widget styling */
    #weather-info .icon {
        width: 80px;
        height: 80px;
        margin-bottom: 10px;
    }
    #weather-info .temperature {
        font-size: 1.8em;
        font-weight: bold;
        color: #ff5722;
    }
    #weather-info .description {
        font-size: 1em;
        color: #555;
        text-transform: capitalize;
    }
    #weather-info .location {
        font-size: 0.9em;
        color: #777;
    }

    /* News widget adjustments for consistent layout */
    #news-widget {
        overflow-y: auto;
        text-align: left;
        padding: 10px;
    }
    #news-widget p {
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    #news-widget a {
        text-decoration: none;
        color: #ff5722;
    }
    #news-widget a:hover {
        text-decoration: underline;
    }

    /* Movie widget styling */
    .movie-item img {
        max-width: 70%; /* Consistent size for movie posters */
        max-height: 180px;
        border-radius: 5px;
        object-fit: cover;
        margin-bottom: 10px;
    }
    .movie-item p {
        font-size: 1em;
        color: #333;
        margin: 0;
    }

    .card-title {
        color: #ff5722;
    }
</style>

<!-- JavaScript for Weather, News, and Movie widgets -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const weatherApiKey = "{{ openweather_api_key }}";
        const mediastackApiKey = "{{ mediastack_api_key }}";
        const tmdbApiKey = "{{ tmdb_api_key }}";

        // Weather widget functionality with dynamic background color
        function fetchWeather(url, lat, lon) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.cod === 200) {
                        const iconUrl = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
                        const location = `${data.name}, ${data.sys.country}`;
                        const condition = data.weather[0].main.toLowerCase();

                        // Determine background color based on main weather condition
                        let backgroundColor;
                        switch (condition) {
                            case 'clear':
                                backgroundColor = '#87CEEB';  // Light blue for clear skies
                                break;
                            case 'clouds':
                                backgroundColor = '#B0C4DE';  // Light steel blue for cloudy
                                break;
                            case 'rain':
                            case 'drizzle':
                                backgroundColor = '#A9A9A9';  // Dark gray for rain
                                break;
                            case 'snow':
                                backgroundColor = '#FFFFFF';  // White for snow
                                break;
                            case 'thunderstorm':
                                backgroundColor = '#778899';  // Gray for thunderstorms
                                break;
                            default:
                                backgroundColor = '#F0F0F0';  // Default light gray for other
                                break;
                        }

                        // Apply the background color
                        document.querySelector('#weather-info').style.backgroundColor = backgroundColor;

                        document.getElementById('weather-info').innerHTML = `
                            <div class="location">${location}</div>
                            <img src="${iconUrl}" alt="${data.weather[0].description}" class="icon" />
                            <div class="temperature">${data.main.temp}Â°C</div>
                            <div class="description">${data.weather[0].description}</div>
                        `;
                    } else {
                        document.getElementById('weather-info').innerText = "Error loading weather data.";
                    }
                })
                .catch(error => console.error('Error fetching weather data:', error));
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude: lat, longitude: lon } = position.coords;
                    fetchWeather(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${weatherApiKey}&units=metric`);
                },
                () => fetchWeather(`https://api.openweathermap.org/data/2.5/weather?q=London&appid=${weatherApiKey}&units=metric`)
            );
        } else {
            fetchWeather(`https://api.openweathermap.org/data/2.5/weather?q=London&appid=${weatherApiKey}&units=metric`);
        }

        // News widget functionality
        fetch(`http://api.mediastack.com/v1/news?access_key=${mediastackApiKey}&countries=us&limit=5`)
            .then(response => response.json())
            .then(data => {
                const newsContainer = document.getElementById('news-widget');
                newsContainer.innerHTML = ''; // Clear loading text
                data.data.forEach(article => {
                    const newsItem = document.createElement('p');
                    newsItem.innerHTML = `<a href="${article.url}" target="_blank">${article.title}</a>`;
                    newsContainer.appendChild(newsItem);
                });
            })
            .catch(error => console.error('Error fetching news:', error));

        // Movie widget functionality
        const moviesUrl = `https://api.themoviedb.org/3/trending/movie/day?api_key=${tmdbApiKey}`;

        let movies = [];
        let currentIndex = 0;

        // Fetch Trending Movies and Save the First Five
        fetch(moviesUrl)
            .then(response => response.json())
            .then(data => {
                movies = data.results.slice(0, 5);
                fetchMovieDetails(); // Fetch IMDb IDs for each movie
                startMovieRotation(); // Start the rotation
            })
            .catch(error => {
                console.error('Error fetching movies:', error);
                document.getElementById('single-movie').innerText = "Error loading movies.";
            });

        // Fetch IMDb ID for each movie
        function fetchMovieDetails() {
            movies.forEach((movie, index) => {
                const movieDetailsUrl = `https://api.themoviedb.org/3/movie/${movie.id}?api_key=${tmdbApiKey}`;

                fetch(movieDetailsUrl)
                    .then(response => response.json())
                    .then(details => {
                        movies[index].imdb_id = details.imdb_id; // Save IMDb ID to the movie object
                        if (index === 0) displayMovie(); // Display the first movie after fetching IMDb ID
                    })
                    .catch(error => console.error('Error fetching movie details:', error));
            });
        }

        // Function to display the current movie
        function displayMovie() {
            const singleMovieContainer = document.getElementById('single-movie');
            if (!singleMovieContainer || movies.length === 0) return;

            const movie = movies[currentIndex];
            const imdbLink = movie.imdb_id ? `https://www.imdb.com/title/${movie.imdb_id}/` : '#';

            singleMovieContainer.innerHTML = `
                <a href="${imdbLink}" target="_blank" style="text-decoration: none;">
                    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" />
                </a>
            `;
        }

        // Start rotating through the movies
        function startMovieRotation() {
            setInterval(() => {
                currentIndex = (currentIndex + 1) % movies.length;
                displayMovie();
            }, 3000); // Rotate every 3 seconds
        }
    });
</script>
{% endblock %}
